name: Build and Deploy Jekyll Atlantic Theme

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: Install dependencies
        run: |
          gem install bundler jekyll
          bundle install || true

      - name: Setup Node and build Tailwind
        run: |
          npm install
          npm run build

      - name: Generate thumbnails
        run: |
          echo "Generating thumbnails..."
          sudo apt-get update
          sudo apt-get install -y imagemagick
          mkdir -p images/thumbs
          find images -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) -exec bash -c '
            for img; do
              filename=$(basename "$img")
              convert "$img" -resize 400x400^ -gravity center -extent 400x400 "images/thumbs/$filename"
              echo "Created thumbnail: images/thumbs/$filename"
            done
          ' bash {} +

      - name: Copy thumbnails into site
        run: |
          echo "Copying thumbnails into site output"
          mkdir -p ./_site/images/thumbs
          cp -r images/thumbs/* ./_site/images/thumbs/ || true

      - name: Build Jekyll site
        run: JEKYLL_ENV=production bundle exec jekyll build -d ./_site

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
