name: Build and Deploy Jekyll Atlantic Theme

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: Install dependencies
        run: |
          gem install bundler jekyll
          bundle install || true

      - name: Setup Node and build Tailwind
        run: |
          npm install
          npm run build

      - name: Generate thumbnails
        run: |
          echo "Generating thumbnails..."
          sudo apt-get update
          sudo apt-get install -y imagemagick
          mkdir -p images/thumbs
          find images -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) -exec bash -c '
            for img; do
              filename=$(basename "$img")
              convert "$img" -resize 400x400^ -gravity center -extent 400x400 "images/thumbs/$filename"
              echo "Created thumbnail: images/thumbs/$filename"
            done
          ' bash {} +

      - name: Copy thumbnails into site
        run: |
          echo "Starting thumbnail copy step..."
          mkdir -p ./_site/images/thumbs

          thumb_count=$(find images/thumbs -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | wc -l)
          echo "Found $thumb_count thumbnails ready to copy."

          if [ "$thumb_count" -eq 0 ]; then
            echo "No thumbnails found to copy. Skipping."
            exit 0
          fi

          copied_count=0
          find images/thumbs -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) -exec bash -c '
            for file; do
              cp "$file" ./_site/images/thumbs/
              ((copied_count++))
              echo "Copied: $(basename "$file")"
            done
            echo "Copied $copied_count thumbnail(s) to ./_site/images/thumbs"
          ' bash {} +

          echo "Copy summary: $thumb_count available, $copied_count copied."

      - name: Build Jekyll site
        run: JEKYLL_ENV=production bundle exec jekyll build -d ./_site

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
